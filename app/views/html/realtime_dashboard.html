{% extends "base.html" %}

{% block title %}Dashboard em Tempo Real - PETBUS{% endblock %}

{% block content %}

<div class="realtime-dashboard">
    <div class="dashboard-header">
        <h1>üìä Dashboard em Tempo Real</h1>
        <p>Acompanhe as atividades do sistema em tempo real</p>
        <div class="connection-status">
            <span id="connection-indicator" class="status-disconnected">‚óè</span>
            <span id="connection-text">Conectando...</span>
        </div>
    </div>

    <div class="dashboard-grid">
        <!-- Painel de Notifica√ß√µes CRUD -->
        <div class="dashboard-card">
            <h3>üîÑ Atividades Recentes</h3>
            <div id="crud-notifications" class="notifications-container">
                {% for activity in initial_activities %}
                <div class="activity-item {{ activity.type }}">
                    <span class="activity-time">{{ activity.time }}</span>
                    <span class="activity-text">
                        <strong>{{ activity.user }}:</strong> {{ activity.text }}
                    </span>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Painel de Estat√≠sticas em Tempo Real -->
        <div class="dashboard-card">
            <h3>üìà Estat√≠sticas do Sistema</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-number" id="total-clientes">{{ stats.total_clientes }}</span>
                    <span class="stat-label">Clientes</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="total-animais">{{ stats.total_animais }}</span>
                    <span class="stat-label">Animais</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="total-veterinarios">{{ stats.total_veterinarios }}</span>
                    <span class="stat-label">Veterin√°rios</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="total-consultas">{{ stats.total_consultas }}</span>
                    <span class="stat-label">Consultas</span>
                </div>
            </div>
            <button id="refresh-stats" class="btn btn-secondary">üîÑ Atualizar Dados</button>
        </div>

        <!-- Painel de Chat em Tempo Real -->
        <div class="dashboard-card">
            <h3>üí¨ Chat do Sistema</h3>
            <div id="chat-messages" class="chat-container">
                <div class="chat-message system">
                    <span class="message-time">{{ now.strftime('%H:%M:%S') }}</span>
                    <span class="message-text">Sistema iniciado</span>
                </div>
            </div>
            <div class="chat-input-container">
                <input type="text" id="chat-input" placeholder="Digite uma mensagem..." maxlength="200">
                <button id="send-message" class="btn btn-primary">Enviar</button>
            </div>
        </div>

        <!-- Painel de Usu√°rios Online -->
        <div class="dashboard-card">
            <h3>üë• Usu√°rios Ativos</h3>
            <div id="active-users" class="users-container">
                <div class="user-item">
                    <span class="user-indicator online">‚óè</span>
                    <span class="user-name">{{ session.username or 'Usu√°rio' }}</span>
                    <span class="user-status">(Voc√™)</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Painel de Controles -->
    <div class="dashboard-controls">
        <button id="test-notification" class="btn btn-info">üß™ Testar Notifica√ß√£o</button>
        <button id="clear-notifications" class="btn btn-warning">üóëÔ∏è Limpar Notifica√ß√µes</button>
        <button id="toggle-sound" class="btn btn-secondary">üîä Som: ON</button>
        <button id="refresh-stats" class="btn btn-secondary">üîÑ Atualizar Dados</button>
    </div>
</div>

<!-- Script WebSocket para o dashboard -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar Socket.IO
    const socket = io();
    let soundEnabled = true;
    
    // Elementos DOM com verifica√ß√£o
    const connectionIndicator = document.getElementById('connection-indicator');
    const connectionText = document.getElementById('connection-text');
    const crudNotifications = document.getElementById('crud-notifications');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendMessageBtn = document.getElementById('send-message');
    
    // Verificar se elementos essenciais existem
    if (!connectionIndicator || !connectionText) {
        console.warn('Elementos de conex√£o n√£o encontrados, mas continuando...');
    }
    
    // Eventos de conex√£o
    socket.on('connect', function() {
        if (connectionIndicator) connectionIndicator.className = 'status-connected';
        if (connectionText) connectionText.textContent = 'Conectado';
        addChatMessage('Sistema', 'Conectado ao servidor em tempo real', 'system');
    });
    
    socket.on('disconnect', function() {
        if (connectionIndicator) connectionIndicator.className = 'status-disconnected';
        if (connectionText) connectionText.textContent = 'Desconectado';
        addChatMessage('Sistema', 'Conex√£o perdida', 'system');
    });
    
    // Receber notifica√ß√µes CRUD
    socket.on('crud_notification', function(data) {
        addCrudNotification(data);
        playNotificationSound();
        updateStats();
    });
    
    // Receber mensagens de chat
    socket.on("new_message", function(data) {
        addChatMessage(data.username, data.message, "user", data.timestamp);
    });
    
    // Receber atualiza√ß√µes de dados
    socket.on('data_update', function(data) {
        updateEntityStats(data.entity_type, data.data.length);
    });
    
    // Fun√ß√µes auxiliares
    function addCrudNotification(data) {
        if (!crudNotifications) return;
        
        const notificationDiv = document.createElement('div');
        notificationDiv.className = `activity-item ${data.operation}`;
        notificationDiv.innerHTML = `
            <span class="activity-time">${data.timestamp}</span>
            <span class="activity-text">
                <strong>${data.user}:</strong> ${data.message}
            </span>
        `;
        
        crudNotifications.insertBefore(notificationDiv, crudNotifications.firstChild);
        
        // Limitar a 15 atividades
        const activities = crudNotifications.querySelectorAll('.activity-item');
        if (activities.length > 15) {
            activities[activities.length - 1].remove();
        }
    }
    
    function addChatMessage(username, message, type, timestamp = null) {
        if (!chatMessages) return;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${type}`;
        const time = timestamp || new Date().toLocaleTimeString();
        messageDiv.innerHTML = `
            <span class="message-time">${time}</span>
            <strong>${username}:</strong> ${message}
        `;
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function updateStats() {
        // Solicitar atualiza√ß√£o de dados para todas as entidades
        socket.emit('request_data_update', {entity_type: 'clientes'});
        socket.emit('request_data_update', {entity_type: 'animais'});
        socket.emit('request_data_update', {entity_type: 'veterinarios'});
        socket.emit('request_data_update', {entity_type: 'consultas'});
    }
    
    function updateEntityStats(entityType, count) {
        const statElement = document.getElementById(`total-${entityType}`);
        if (statElement) {
            statElement.textContent = count;
        }
    }
    
    function playNotificationSound() {
        if (soundEnabled) {
            // Criar um beep simples usando Web Audio API
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                console.log('Audio n√£o suportado');
            }
        }
    }
    
    // Event listeners com verifica√ß√£o de exist√™ncia
    const refreshBtn = document.getElementById('refresh-stats');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', updateStats);
    }
    
    const testNotBtn = document.getElementById('test-notification');
    if (testNotBtn) {
        testNotBtn.addEventListener('click', function() {
            socket.emit('system_notification', {
                message: 'Esta √© uma notifica√ß√£o de teste do sistema!',
                type: 'info'
            });
        });
    }
    
    const clearBtn = document.getElementById('clear-notifications');
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            if (crudNotifications) {
                crudNotifications.innerHTML = '<p class="no-notifications">Aguardando atividades...</p>';
            }
        });
    }
    
    const toggleSoundBtn = document.getElementById('toggle-sound');
    if (toggleSoundBtn) {
        toggleSoundBtn.addEventListener('click', function() {
            soundEnabled = !soundEnabled;
            this.textContent = soundEnabled ? 'üîä Som: ON' : 'üîá Som: OFF';
        });
    }
    
    if (sendMessageBtn && chatInput) {
        sendMessageBtn.addEventListener('click', function() {
            const message = chatInput.value.trim();
            if (message) {
                socket.emit('send_message', {
                    message: message,
                    room: 'general'
                });
                chatInput.value = '';
            }
        });
        
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessageBtn.click();
            }
        });
    }
    
    // Carregar estat√≠sticas iniciais
    updateStats();
    
    // Entrar na sala geral para chat
    socket.emit('join', {room: 'general'});
    
    // Simular atividades do sistema periodicamente
    setInterval(function() {
        const systemActivities = [
            "Verifica√ß√£o autom√°tica de integridade dos dados",
            "Sincroniza√ß√£o de dados em tempo real ativa",
            "Monitoramento de performance do sistema",
            "Backup autom√°tico realizado com sucesso"
        ];
        
        const randomActivity = systemActivities[Math.floor(Math.random() * systemActivities.length)];
        
        if (Math.random() > 0.7) { // 30% de chance de mostrar atividade
            addCrudNotification({
                message: randomActivity,
                user: 'Sistema',
                operation: 'system',
                timestamp: new Date().toLocaleTimeString()
            });
        }
    }, 30000); // A cada 30 segundos
});
</script>
{% endblock %}
